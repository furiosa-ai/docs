<!DOCTYPE html>
<html class="writer-html5" lang="ko" >
<head>
  <meta charset="utf-8" /><meta name="generator" content="Docutils 0.18.1: http://docutils.sourceforge.net/" />

  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Kubernetes 지원 &mdash; FuriosaAI NPU 및 Software 문서  문서</title>
      <link rel="stylesheet" href="../_static/pygments.css" type="text/css" />
      <link rel="stylesheet" href="../_static/css/theme.css" type="text/css" />
      <link rel="stylesheet" href="../_static/tabs.css" type="text/css" />
      <link rel="stylesheet" href="../_static/custom.css" type="text/css" />
  <!--[if lt IE 9]>
    <script src="../_static/js/html5shiv.min.js"></script>
  <![endif]-->
  
        <script src="../_static/jquery.js"></script>
        <script src="../_static/_sphinx_javascript_frameworks_compat.js"></script>
        <script data-url_root="../" id="documentation_options" src="../_static/documentation_options.js"></script>
        <script src="../_static/doctools.js"></script>
        <script src="../_static/sphinx_highlight.js"></script>
        <script src="../_static/translations.js"></script>
    <script src="../_static/js/theme.js"></script>
    <link rel="index" title="색인" href="../genindex.html" />
    <link rel="search" title="검색" href="../search.html" />
    <link rel="next" title="가상 머신 환경 지원" href="vm_support.html" />
    <link rel="prev" title="모델 서버 (서빙 프레임워크)" href="serving.html" /> 
</head>

<body class="wy-body-for-nav"> 
  <div class="wy-grid-for-nav">
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >

          
          
          <a href="../index.html" class="icon icon-home">
            FuriosaAI NPU 및 Software 문서
          </a>
              <div class="version">
                0.10.0
              </div>
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" aria-label="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>
        </div><div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="Navigation menu">
              <p class="caption" role="heading"><span class="caption-text">FuriosaAI NPU</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../npu/warboy.html">FuriosaAI Warboy</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">FuriosaAI 소프트웨어</span></p>
<ul class="current">
<li class="toctree-l1"><a class="reference internal" href="intro.html">FuriosaAI 소프트웨어 스택 소개</a></li>
<li class="toctree-l1"><a class="reference internal" href="installation.html">드라이버, 펌웨어, 런타임 설치 가이드</a></li>
<li class="toctree-l1"><a class="reference internal" href="python-sdk.html">Python SDK 설치 및 사용 가이드</a></li>
<li class="toctree-l1"><a class="reference internal" href="c-sdk.html">C SDK 설치 및 사용 가이드</a></li>
<li class="toctree-l1"><a class="reference internal" href="cli.html">명령행 도구</a></li>
<li class="toctree-l1"><a class="reference internal" href="compiler.html">컴파일러</a></li>
<li class="toctree-l1"><a class="reference internal" href="quantization.html">모델 양자화</a></li>
<li class="toctree-l1"><a class="reference internal" href="performance.html">성능 최적화</a></li>
<li class="toctree-l1"><a class="reference internal" href="profiler.html">성능 프로파일링</a></li>
<li class="toctree-l1"><a class="reference external" href="https://furiosa-ai.github.io/furiosa-models/latest/">FuriosaAI Model Zoo</a></li>
<li class="toctree-l1"><a class="reference internal" href="serving.html">모델 서버 (서빙 프레임워크)</a></li>
<li class="toctree-l1 current"><a class="current reference internal" href="#">Kubernetes 지원</a><ul>
<li class="toctree-l2"><a class="reference internal" href="#npu">1. NPU 노드 준비</a></li>
<li class="toctree-l2"><a class="reference internal" href="#setupnodefeaturediscovery">2. Node Feature Discovery 설치</a></li>
<li class="toctree-l2"><a class="reference internal" href="#device-plugin-npu-feature-discovery-npu-metrics-exporter">3. Device Plugin, NPU Feature Discovery, NPU Metrics Exporter 설치</a><ul>
<li class="toctree-l3"><a class="reference internal" href="#device-plugin">Device Plugin 설정</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="#npu-pod">4. NPU와 함께 Pod 배포</a></li>
<li class="toctree-l2"><a class="reference internal" href="#id4">5. NPU 모니터링</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="vm_support.html">가상 머신 환경 지원</a></li>
<li class="toctree-l1"><a class="reference internal" href="tutorials.html">튜토리얼 및 코드 예제</a></li>
<li class="toctree-l1"><a class="reference internal" href="references.html">레퍼런스 문서</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">SDK 릴리즈 노트</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../releases/0.10.0.html">Release Notes - 0.10.0</a></li>
<li class="toctree-l1"><a class="reference internal" href="../releases/0.9.0.html">Release Notes - 0.9.0</a></li>
<li class="toctree-l1"><a class="reference internal" href="../releases/0.8.0.html">Release Notes - 0.8.0</a></li>
<li class="toctree-l1"><a class="reference internal" href="../releases/0.7.0.html">Release Notes - 0.7.0</a></li>
<li class="toctree-l1"><a class="reference internal" href="../releases/0.6.0.html">Release Notes - 0.6.0</a></li>
<li class="toctree-l1"><a class="reference internal" href="../releases/0.5.0.html">Release Notes - 0.5.0</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">고객 지원</span></p>
<ul>
<li class="toctree-l1"><a class="reference external" href="https://furiosa-ai.discourse.group/">Furiosa SDK 사용자 게시판</a></li>
<li class="toctree-l1"><a class="reference external" href="https://furiosa-ai.atlassian.net/servicedesk/customer/portals/">FuriosaAI 고객지원 센터</a></li>
<li class="toctree-l1"><a class="reference internal" href="../customer-support/bugs.html">버그 신고</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">기존 버전 문서</span></p>
<ul>
<li class="toctree-l1"><a class="reference external" href="https://furiosa-ai.github.io/docs/v0.9.0/ko/">0.9.0 문서</a></li>
<li class="toctree-l1"><a class="reference external" href="https://furiosa-ai.github.io/docs/v0.8.0/ko/">0.8.0 문서</a></li>
<li class="toctree-l1"><a class="reference external" href="https://furiosa-ai.github.io/docs/v0.7.0/ko/">0.7.0 문서</a></li>
<li class="toctree-l1"><a class="reference external" href="https://furiosa-ai.github.io/docs/v0.6.3/ko/">0.6.3 문서</a></li>
<li class="toctree-l1"><a class="reference external" href="https://furiosa-ai.github.io/docs/v0.6.0/ko/">0.6.0 문서</a></li>
<li class="toctree-l1"><a class="reference external" href="https://furiosa-ai.github.io/docs/v0.5.0/ko/">0.5.0 문서</a></li>
<li class="toctree-l1"><a class="reference external" href="https://furiosa-ai.github.io/docs/v0.2.0/ko/">0.2.0 문서</a></li>
</ul>

        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap"><nav class="wy-nav-top" aria-label="Mobile navigation menu" >
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../index.html">FuriosaAI NPU 및 Software 문서</a>
      </nav>

      <div class="wy-nav-content">
        <div class="rst-content">
          <div role="navigation" aria-label="Page navigation">
  <ul class="wy-breadcrumbs">
      <li><a href="../index.html" class="icon icon-home" aria-label="Home"></a></li>
      <li class="breadcrumb-item active">Kubernetes 지원</li>
      <li class="wy-breadcrumbs-aside">
            <a href="../_sources/software/kubernetes_support.rst.txt" rel="nofollow"> View page source</a>
      </li>
  </ul>
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
             
  <section id="kubernetes">
<span id="kubernetesintegration"></span><h1>Kubernetes 지원<a class="headerlink" href="#kubernetes" title="이 제목에 대한 퍼머링크"></a></h1>
<p><a class="reference external" href="https://kubernetes.io/">Kubernetes</a> 는 컨테이너화된 워크로드와 서비스를
관리하는 오픈소스 플랫폼이다. FuriosaAI SDK는 Kubernetes 환경 지원을 위해 다음 컴포넌트를 제공한다.</p>
<ul class="simple">
<li><p>FuriosaAI NPU Device Plugin (<a class="reference external" href="https://kubernetes.io/docs/concepts/extend-kubernetes/compute-storage-net/device-plugins/">Kubernetes Device Plugin 소개</a>)</p></li>
<li><p>FuriosaAI NPU Feature Discovery (<a class="reference external" href="https://kubernetes-sigs.github.io/node-feature-discovery/stable/get-started/index.html">Node Feature Discovery 소개</a>)</p></li>
<li><p>FuriosaAI NPU Metrics Exporter</p></li>
</ul>
<p>위의 컴포넌트는 다음 기능을 제공한다.</p>
<ul class="simple">
<li><p>노드에 가용한 NPU를 Kubernetes 클러스터가 인식하게 한다.</p></li>
<li><p>Kubernetes의 <code class="docutils literal notranslate"><span class="pre">spec.containers[].resources.limits</span></code> 를 통해 Pod 워크로드 배포 시 NPU를 함께 스케쥴링 하게 한다.</p></li>
<li><p>NPU가 장착된 머신의 NPU의 정보를 파악하여 노드의 레이블로 등록한다 (이 정보와 <code class="docutils literal notranslate"><span class="pre">nodeSelector</span></code> 등을 사용하면 Pod을 선택적으로 스케쥴링할 수 있다).</p>
<ul>
<li><p>node-feature-discovery가 클러스터에 설치되어 있어야 하며, NPU가 장착된 노드에 <code class="docutils literal notranslate"><span class="pre">nfd-worker</span></code> Pod이 실행되고 있어야 한다.</p></li>
</ul>
</li>
<li><p>노드에 장착된 NPU의 상태 정보를 Prometheus에서 수집할 수 있게 한다.</p></li>
</ul>
<p>Kubernetes 지원을 위한 셋업 과정은 다음 순서를 따라 진행하면 된다.</p>
<section id="npu">
<h2>1. NPU 노드 준비<a class="headerlink" href="#npu" title="이 제목에 대한 퍼머링크"></a></h2>
<p>Kubernetes 노드의 요구 사항은 다음과 같다.</p>
<ul class="simple">
<li><p>Ubuntu 20.04 또는 상위 버전</p></li>
<li><p>Intel 호환 CPU</p></li>
</ul>
<p>또한, NPU가 장착된 Kubernetes의 각 Node에 NPU 드라이버와 toolkit을 설치해야 한다.
APT 서버가 셋업되어 있다면 (<a class="reference internal" href="installation.html#setupaptrepository"><span class="std std-ref">APT 서버 설정</span></a> 참고) 다음과 같이 간단히 설치할 수 있다.</p>
<div class="highlight-sh notranslate"><div class="highlight"><pre><span></span>apt-get<span class="w"> </span>update<span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span>apt<span class="w"> </span>install<span class="w"> </span>-y<span class="w"> </span>furiosa-driver-warboy<span class="w"> </span>furiosa-toolkit
</pre></div>
</div>
<p>위 필수 패키지가 설치되면 furiosa-toolkit에 포함된 furiosactl 커맨드로 아래와 같이 NPU 인식을 확인해 볼 수 있다.
만약 아래 커맨드로 NPU가 인식되지 않는다면 환경에 따라 재부팅 후에 다시 시도해본다.</p>
<div class="highlight-sh notranslate"><div class="highlight"><pre><span></span>$<span class="w"> </span>furiosactl<span class="w"> </span>info
+------+------------------+-------+--------+--------------+---------+
<span class="p">|</span><span class="w"> </span>NPU<span class="w">  </span><span class="p">|</span><span class="w"> </span>Name<span class="w">             </span><span class="p">|</span><span class="w"> </span>Temp.<span class="w"> </span><span class="p">|</span><span class="w"> </span>Power<span class="w">  </span><span class="p">|</span><span class="w"> </span>PCI-BDF<span class="w">      </span><span class="p">|</span><span class="w"> </span>PCI-DEV<span class="w"> </span><span class="p">|</span>
+------+------------------+-------+--------+--------------+---------+
<span class="p">|</span><span class="w"> </span>npu0<span class="w"> </span><span class="p">|</span><span class="w"> </span>FuriosaAI<span class="w"> </span>Warboy<span class="w"> </span><span class="p">|</span><span class="w">  </span><span class="m">40</span>°C<span class="w"> </span><span class="p">|</span><span class="w"> </span><span class="m">1</span>.37<span class="w"> </span>W<span class="w"> </span><span class="p">|</span><span class="w"> </span><span class="m">0000</span>:01:00.0<span class="w"> </span><span class="p">|</span><span class="w"> </span><span class="m">509</span>:0<span class="w">   </span><span class="p">|</span>
+------+------------------+-------+--------+--------------+---------+
</pre></div>
</div>
</section>
<section id="setupnodefeaturediscovery">
<span id="id2"></span><h2>2. Node Feature Discovery 설치<a class="headerlink" href="#setupnodefeaturediscovery" title="이 제목에 대한 퍼머링크"></a></h2>
<p>Kubernetes에서 NPU를 활용하기 위해서는 Node Feature Discovery가 필요하다.
아래 예제처럼 커맨드를 실행하여 <code class="docutils literal notranslate"><span class="pre">feature.node.kubernetes.io/...</span></code> 로 시작되는 노드 레이블이 있다면 Node Feature Discovery의 DaemonSet이 이미 설치된 것으로 볼 수 있다.</p>
<div class="highlight-sh notranslate"><div class="highlight"><pre><span></span>$<span class="w"> </span>kubectl<span class="w"> </span>get<span class="w"> </span>no<span class="w"> </span>-o<span class="w"> </span>json<span class="w"> </span><span class="p">|</span><span class="w"> </span>jq<span class="w"> </span><span class="s1">&#39;.items[].metadata.labels&#39;</span>
<span class="o">{</span>
<span class="w">  </span><span class="s2">&quot;beta.kubernetes.io/arch&quot;</span>:<span class="w"> </span><span class="s2">&quot;amd64&quot;</span>,
<span class="w">  </span><span class="s2">&quot;beta.kubernetes.io/os&quot;</span>:<span class="w"> </span><span class="s2">&quot;linux&quot;</span>,
<span class="w">  </span><span class="s2">&quot;feature.node.kubernetes.io/cpu-cpuid.ADX&quot;</span>:<span class="w"> </span><span class="s2">&quot;true&quot;</span>,
<span class="w">  </span><span class="s2">&quot;feature.node.kubernetes.io/cpu-cpuid.AESNI&quot;</span>:<span class="w"> </span><span class="s2">&quot;true&quot;</span>,
<span class="w">  </span>...
</pre></div>
</div>
<ul class="simple">
<li><p>만약 Node Feature Discovery가 설치되어 있지 않다면 다음 문서를 참조하여 설치할 수 있다.</p>
<ul>
<li><p><a class="reference external" href="https://kubernetes-sigs.github.io/node-feature-discovery/v0.11/get-started/quick-start.html#installation">Quick start / Installation</a></p></li>
</ul>
</li>
<li><p>Node Feature Discovery 실행 시 다음 옵션이 적용되어 있어야 한다.</p>
<ul>
<li><p><code class="docutils literal notranslate"><span class="pre">nfd-master</span></code> 의 <code class="docutils literal notranslate"><span class="pre">--extra-label-ns</span></code> 옵션에 <code class="docutils literal notranslate"><span class="pre">beta.furiosa.ai</span></code> 가 포함되어 있어야 함</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">nfd-worker</span></code> 의 config 파일에</p>
<ul>
<li><p><code class="docutils literal notranslate"><span class="pre">sources.pci.deviceLabelFields</span></code> 의 값에 <code class="docutils literal notranslate"><span class="pre">vendor</span></code> 만 있어야 함</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">sources.pci.deviceClassWhitelist</span></code> 의 값 중 <code class="docutils literal notranslate"><span class="pre">&quot;12&quot;</span></code> 가 포함되어 있어야 함</p></li>
</ul>
</li>
</ul>
</li>
</ul>
<div class="literal-block-wrapper docutils container" id="id5">
<div class="code-block-caption"><span class="caption-text">nfd-worker.conf</span><a class="headerlink" href="#id5" title="이 코드에 대한 퍼머링크"></a></div>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">sources</span><span class="p">:</span>
  <span class="n">pci</span><span class="p">:</span>
    <span class="n">deviceClassWhitelist</span><span class="p">:</span>
    <span class="o">-</span> <span class="s2">&quot;02&quot;</span>
    <span class="o">-</span> <span class="s2">&quot;0200&quot;</span>
    <span class="o">-</span> <span class="s2">&quot;0207&quot;</span>
    <span class="o">-</span> <span class="s2">&quot;0300&quot;</span>
    <span class="o">-</span> <span class="s2">&quot;0302&quot;</span>
    <span class="o">-</span> <span class="s2">&quot;12&quot;</span>
    <span class="n">deviceLabelFields</span><span class="p">:</span>
    <span class="o">-</span> <span class="n">vendor</span>
</pre></div>
</div>
</div>
<div class="admonition note">
<p class="admonition-title">참고</p>
<p>Node Feature Discovery는 필수 컴포넌트가 아니지만 설치를 권장한다. 미사용 시 수행해야 하는 추가 작업에 대해서는 다음 단계에서 설명한다.</p>
</div>
</section>
<section id="device-plugin-npu-feature-discovery-npu-metrics-exporter">
<span id="installingdevicepluginandnfd"></span><h2>3. Device Plugin, NPU Feature Discovery, NPU Metrics Exporter 설치<a class="headerlink" href="#device-plugin-npu-feature-discovery-npu-metrics-exporter" title="이 제목에 대한 퍼머링크"></a></h2>
<p>NPU 노드 준비가 완료되면, Device Plugin, NPU Feature Discovery와 NPU Metrics Exporter의 DaemonSet을 다음과 같이 설치한다.</p>
<div class="highlight-sh notranslate"><div class="highlight"><pre><span></span>kubectl<span class="w"> </span>apply<span class="w"> </span>-f<span class="w"> </span>https://raw.githubusercontent.com/furiosa-ai/furiosa-sdk/0.8.0/kubernetes/deployments/device-plugin.yaml
kubectl<span class="w"> </span>apply<span class="w"> </span>-f<span class="w"> </span>https://raw.githubusercontent.com/furiosa-ai/furiosa-sdk/0.8.0/kubernetes/deployments/npu-feature-discovery.yaml
kubectl<span class="w"> </span>apply<span class="w"> </span>-f<span class="w"> </span>https://raw.githubusercontent.com/furiosa-ai/furiosa-sdk/0.8.0/kubernetes/deployments/npu-metrics-exporter.yaml
</pre></div>
</div>
<p>위 커맨드를 실행하고 난 뒤에 <code class="docutils literal notranslate"><span class="pre">kubectl</span> <span class="pre">get</span> <span class="pre">daemonset</span> <span class="pre">-n</span> <span class="pre">kube-system</span></code> 명령으로 설치한 DaemonSet이 정상 동작하는지 확인할 수 있다.
참고로 이 DaemonSet들은 NPU가 장착된 노드에만 배포되며 이를 위해 Node Feature Discovery가 각 node에 붙여주는 <code class="docutils literal notranslate"><span class="pre">feature.node.kubernetes.io/pci-1ed2.present=true</span></code> 정보를 사용한다.</p>
<div class="highlight-sh notranslate"><div class="highlight"><pre><span></span>$<span class="w"> </span>kubectl<span class="w"> </span>get<span class="w"> </span>daemonset<span class="w"> </span>-n<span class="w"> </span>kube-system
NAME<span class="w">                           </span>DESIRED<span class="w">   </span>CURRENT<span class="w">   </span>READY<span class="w">   </span>UP-TO-DATE<span class="w">   </span>AVAILABLE<span class="w">   </span>NODE<span class="w"> </span>SELECTOR<span class="w">                                      </span>AGE
furiosa-device-plugin<span class="w">          </span><span class="m">3</span><span class="w">         </span><span class="m">3</span><span class="w">         </span><span class="m">3</span><span class="w">       </span><span class="m">3</span><span class="w">            </span><span class="m">3</span><span class="w">           </span>feature.node.kubernetes.io/pci-1ed2.present<span class="o">=</span><span class="nb">true</span><span class="w">   </span>128m
furiosa-npu-feature-discovery<span class="w">  </span><span class="m">3</span><span class="w">         </span><span class="m">3</span><span class="w">         </span><span class="m">3</span><span class="w">       </span><span class="m">3</span><span class="w">            </span><span class="m">3</span><span class="w">           </span>feature.node.kubernetes.io/pci-1ed2.present<span class="o">=</span><span class="nb">true</span><span class="w">   </span>162m
furiosa-npu-metrics-exporter<span class="w">   </span><span class="m">3</span><span class="w">         </span><span class="m">3</span><span class="w">         </span><span class="m">3</span><span class="w">       </span><span class="m">3</span><span class="w">            </span><span class="m">3</span><span class="w">           </span>feature.node.kubernetes.io/pci-1ed2.present<span class="o">=</span><span class="nb">true</span><span class="w">   </span>162m
</pre></div>
</div>
<p>만약 <a class="reference internal" href="#setupnodefeaturediscovery"><span class="std std-ref">단계 2</span></a> 에서 Node Feature Discovery 설치를 생략하였다면 NPU Feature Discovery는 설치가 불필요하며, 나머지 컴포넌트는 다음 절차를 추가로 수행한 후 설치가 가능하다.</p>
<ul class="simple">
<li><p>위에서 제시한 YAML 파일을 수정하여 DaemonSet의 nodeSelector 조건을 변경하고 설치해야 함</p>
<ul>
<li><p>컴포넌트를 클러스터 내의 모든 노드에 설치할 경우</p>
<ul>
<li><p><code class="docutils literal notranslate"><span class="pre">feature.node.kubernetes.io/pci-1ed2.present:</span> <span class="pre">&quot;true&quot;</span></code> 를 제거</p></li>
</ul>
</li>
<li><p>컴포넌트를 클러스터 내에서 NPU가 설치된 일부 노드에 설치할 경우</p>
<ul>
<li><p>해당하는 노드에 label을 추가 (예, <code class="docutils literal notranslate"><span class="pre">kubectl</span> <span class="pre">label</span> <span class="pre">node</span> <span class="pre">&lt;nodename&gt;</span> <span class="pre">furiosa=true</span></code> )</p></li>
<li><p>nodeSelector 조건을 변경 (예, <code class="docutils literal notranslate"><span class="pre">feature.node.kubernetes.io/pci-1ed2.present:</span> <span class="pre">&quot;true&quot;</span></code> 대신 <code class="docutils literal notranslate"><span class="pre">furiosa:</span> <span class="pre">&quot;true&quot;</span></code> )</p></li>
</ul>
</li>
</ul>
</li>
</ul>
<p>NPU Feature Discovery가 노드에 레이블로 붙여주는 메타데이터는 다음 표와 같다.</p>
<span id="k8snodelabels"></span><table class="docutils align-default" id="id6">
<caption><span class="caption-text">NPU Node Labels</span><a class="headerlink" href="#id6" title="이 표에 대한 퍼머링크"></a></caption>
<colgroup>
<col style="width: 33%" />
<col style="width: 33%" />
<col style="width: 33%" />
</colgroup>
<thead>
<tr class="row-odd"><th class="head"><p>레이블(Label)</p></th>
<th class="head"><p>값(Value)</p></th>
<th class="head"><p>설명(Description)</p></th>
</tr>
</thead>
<tbody>
<tr class="row-even"><td><p>beta.furiosa.ai/npu.count</p></td>
<td><p>1</p></td>
<td><p>해당 노드에 장착된 NPU의 수</p></td>
</tr>
<tr class="row-odd"><td><p>beta.furiosa.ai/npu.product</p></td>
<td><p>warboy, warboyB0</p></td>
<td><p>NPU 제품명(코드)</p></td>
</tr>
<tr class="row-even"><td><p>beta.furiosa.ai/npu.family</p></td>
<td><p>warboy, renegade</p></td>
<td><p>NPU 아키텍쳐(Family)</p></td>
</tr>
<tr class="row-odd"><td><p>beta.furiosa.ai/machine.vendor</p></td>
<td><p>(depends on machine)</p></td>
<td><p>머신의 제조사</p></td>
</tr>
<tr class="row-even"><td><p>beta.furiosa.ai/machine.name</p></td>
<td><p>(depends on machine)</p></td>
<td><p>머신의 제품명(코드)</p></td>
</tr>
<tr class="row-odd"><td><p>beta.furiosa.ai/driver.version</p></td>
<td><p>1.3.0</p></td>
<td><p>NPU Device Driver의 버전</p></td>
</tr>
<tr class="row-even"><td><p>beta.furiosa.ai/driver.version.major</p></td>
<td><p>1</p></td>
<td><p>NPU Device Driver의 버전 중 major 파트</p></td>
</tr>
<tr class="row-odd"><td><p>beta.furiosa.ai/driver.version.minor</p></td>
<td><p>3</p></td>
<td><p>NPU Device Driver의 버전 중 minor 파트</p></td>
</tr>
<tr class="row-even"><td><p>beta.furiosa.ai/driver.version.patch</p></td>
<td><p>0</p></td>
<td><p>NPU Device Driver의 버전 중 patch 파트</p></td>
</tr>
<tr class="row-odd"><td><p>beta.furiosa.ai/driver.reference</p></td>
<td><p>57ac7b0</p></td>
<td><p>NPU Device Driver 빌드의 commit hash</p></td>
</tr>
</tbody>
</table>
<p>노드의 레이블을 확인하고 싶다면 <code class="docutils literal notranslate"><span class="pre">kubectl</span> <span class="pre">get</span> <span class="pre">nodes</span> <span class="pre">--show-labels</span></code> 명령을 실행하면 된다.
다음과 같이 <code class="docutils literal notranslate"><span class="pre">beta.furiosa.ai</span></code> 로 시작하는 레이블이 보이면 정상적으로 설치된 것이다.</p>
<div class="highlight-sh notranslate"><div class="highlight"><pre><span></span>kubectl<span class="w"> </span>get<span class="w"> </span>nodes<span class="w"> </span>--show-labels

warboy-node01<span class="w">     </span>Ready<span class="w">   </span>&lt;none&gt;<span class="w">  </span>65d<span class="w">   </span>v1.20.10<span class="w">   </span>beta.furiosa.ai/npu.count<span class="o">=</span><span class="m">1</span>,beta.furiosa.ai/npu.product<span class="o">=</span>warboy...,kubernetes.io/os<span class="o">=</span>linux
warboy-node02<span class="w">     </span>Ready<span class="w">   </span>&lt;none&gt;<span class="w">  </span>12d<span class="w">   </span>v1.20.10<span class="w">   </span>beta.furiosa.ai/npu.count<span class="o">=</span><span class="m">1</span>,beta.furiosa.ai/npu.product<span class="o">=</span>warboy...,kubernetes.io/os<span class="o">=</span>linux
</pre></div>
</div>
<section id="device-plugin">
<h3>Device Plugin 설정<a class="headerlink" href="#device-plugin" title="이 제목에 대한 퍼머링크"></a></h3>
<p>Device Plugin의 실행 옵션은 명령행의 인자로 지정하거나 설정 파일을 통해 지정할 수 있도록 두 가지 방법을 제공한다.</p>
<ol class="arabic simple">
<li><p>명령행 입력 방식</p></li>
</ol>
<p><code class="docutils literal notranslate"><span class="pre">k8s-device-plugin</span></code> 명령을 실행하면서 인자를 통해 옵션을 지정할 수 있다.</p>
<div class="highlight-sh notranslate"><div class="highlight"><pre><span></span>$<span class="w"> </span>k8s-device-plugin<span class="w"> </span>--interval<span class="w"> </span><span class="m">10</span>
</pre></div>
</div>
<p>Pod 또는 DaemonSet 명세에서는 다음과 같이 명령행 인자를 설정 할 수 있다.</p>
<div class="highlight-yaml notranslate"><div class="highlight"><pre><span></span><span class="nt">apiVersion</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">v1</span>
<span class="nt">kind</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">Pod</span>
<span class="nt">metadata</span><span class="p">:</span>
<span class="w">  </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">furiosa-device-plugin</span>
<span class="w">  </span><span class="nt">namespace</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">kube-system</span>
<span class="nt">spec</span><span class="p">:</span>
<span class="w">  </span><span class="nt">containers</span><span class="p">:</span>
<span class="w">    </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">device-plugin</span>
<span class="w">      </span><span class="nt">image</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">ghcr.io/furiosa-ai/k8s-device-plugin:latest</span>
<span class="w">      </span><span class="nt">command</span><span class="p">:</span><span class="w"> </span><span class="p p-Indicator">[</span><span class="s">&quot;/usr/bin/k8s-device-plugin&quot;</span><span class="p p-Indicator">]</span>
<span class="w">      </span><span class="nt">args</span><span class="p">:</span><span class="w"> </span><span class="p p-Indicator">[</span><span class="s">&quot;--interval&quot;</span><span class="p p-Indicator">,</span><span class="w"> </span><span class="s">&quot;10&quot;</span><span class="p p-Indicator">]</span>
<span class="c1"># (이하 생략)</span>
</pre></div>
</div>
<table class="docutils align-default" id="id7">
<caption><span class="caption-text">k8s-device-plugin 인자 목록</span><a class="headerlink" href="#id7" title="이 표에 대한 퍼머링크"></a></caption>
<colgroup>
<col style="width: 20%" />
<col style="width: 60%" />
<col style="width: 20%" />
</colgroup>
<thead>
<tr class="row-odd"><th class="head"><p>항목</p></th>
<th class="head"><p>설명</p></th>
<th class="head"><p>기본값</p></th>
</tr>
</thead>
<tbody>
<tr class="row-even"><td><p>default-pe</p></td>
<td><p>Pod 할당 시 기본값으로 적용되는 Core 유형 (Fusion/Single)</p></td>
<td><p>Fusion</p></td>
</tr>
<tr class="row-odd"><td><p>interval</p></td>
<td><p>장치 탐색 주기 (단위: 초)</p></td>
<td><p>10</p></td>
</tr>
<tr class="row-even"><td><p>disabled-devices</p></td>
<td><p>할당 대상에서 제외할 장치 지정(콤마로 여러 장치를 지정 가능)</p></td>
<td></td>
</tr>
<tr class="row-odd"><td><p>plugin-dir</p></td>
<td><p>kubelet의 device-plugin 디렉토리 경로</p></td>
<td><p>/var/lib/kubelet/device-plugins</p></td>
</tr>
<tr class="row-even"><td><p>socket-name</p></td>
<td><p>&lt;plugin-dir&gt; 아래에 생성할 socket 파일의 이름</p></td>
<td><p>furiosa-npu</p></td>
</tr>
<tr class="row-odd"><td><p>resource-name</p></td>
<td><p>k8s 노드에 등록할 NPU 자원의 이름</p></td>
<td><p>beta.furiosa.ai/npu</p></td>
</tr>
</tbody>
</table>
<ol class="arabic simple" start="2">
<li><p>설정파일 지정 방식</p></li>
</ol>
<p><code class="docutils literal notranslate"><span class="pre">k8s-device-plugin</span></code> 명령을 실행하면서 <code class="docutils literal notranslate"><span class="pre">config-file</span></code> 인자를 통해 설정 파일을 지정할 수 있다.
단, <code class="docutils literal notranslate"><span class="pre">config-file</span></code> 을 지정한 경우 나머지 인자들은 사용할 수 없다.</p>
<div class="highlight-sh notranslate"><div class="highlight"><pre><span></span>$<span class="w"> </span>k8s-device-plugin<span class="w"> </span>--config-file<span class="w"> </span>/etc/furiosa/device-plugin.conf
</pre></div>
</div>
<div class="literal-block-wrapper docutils container" id="id8">
<div class="code-block-caption"><span class="caption-text">/etc/furiosa/device-plugin.conf</span><a class="headerlink" href="#id8" title="이 코드에 대한 퍼머링크"></a></div>
<div class="highlight-yaml notranslate"><div class="highlight"><pre><span></span><span class="nt">interval</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">10</span>
<span class="nt">defaultPe</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">Fusion</span>
<span class="nt">disabledDevices</span><span class="p">:</span><span class="w">             </span><span class="c1"># warboy-node01 노드의 npu1 장치를 사용하지 않음을 의미</span>
<span class="w">  </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">devName</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">npu1</span>
<span class="w">    </span><span class="nt">nodeName</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">warboy-node01</span>
<span class="nt">pluginDir</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">/var/lib/kubelet/device-plugins</span>
<span class="nt">socketName</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">furiosa-npu</span>
<span class="nt">resourceName</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">beta.furiosa.ai/npu</span>
</pre></div>
</div>
</div>
<p>설정 파일은 Yaml 포맷의 텍스트 형태이다. 파일 내용이 변경되면 변경 사항이 Device Plugin에 즉시 적용된다. 설정이 업데이트 되었음은 Device Plugin의 로그를 통해 확인할 수 있다.
(단, <code class="docutils literal notranslate"><span class="pre">pluginDir</span></code> , <code class="docutils literal notranslate"><span class="pre">socketName</span></code>, <code class="docutils literal notranslate"><span class="pre">resourceName</span></code> 이 항목들의 변경을 적용하기 위해서는 재시작이 필요하다.)</p>
<p><a class="reference internal" href="#installingdevicepluginandnfd"><span class="std std-ref">3. Device Plugin, NPU Feature Discovery, NPU Metrics Exporter 설치</span></a> 의 설치에서 제공하는 <code class="docutils literal notranslate"><span class="pre">device-plugin.yaml</span></code> 는 기본적으로 ConfigMap 기반의 설정 파일을 사용하는 구성을 제공한다.
만약 Device Plugin의 실행 옵션을 변경하고 싶다면 이 ConfigMap을 수정하고, 변경된 ConfigMap이 Pod에 반영되면 Device Plugin은 이를 읽고 변경사항을 적용한다.</p>
<div class="highlight-sh notranslate"><div class="highlight"><pre><span></span>$<span class="w"> </span>kubectl<span class="w"> </span>edit<span class="w"> </span>configmap<span class="w"> </span>npu-device-plugin<span class="w"> </span>-n<span class="w"> </span>kube-system
</pre></div>
</div>
<div class="literal-block-wrapper docutils container" id="id9">
<div class="code-block-caption"><span class="caption-text">configmap/npu-device-plugin</span><a class="headerlink" href="#id9" title="이 코드에 대한 퍼머링크"></a></div>
<div class="highlight-yaml notranslate"><div class="highlight"><pre><span></span><span class="nt">apiVersion</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">v1</span>
<span class="nt">data</span><span class="p">:</span>
<span class="w">  </span><span class="nt">config.yaml</span><span class="p">:</span><span class="w"> </span><span class="p p-Indicator">|</span>
<span class="w">    </span><span class="no">defaultPe: Fusion</span>
<span class="w">    </span><span class="no">interval: 15</span>
<span class="w">    </span><span class="no">disabledDevices:</span>
<span class="w">      </span><span class="no">- devName: npu2</span>
<span class="w">        </span><span class="no">nodeName: npu-001</span>
<span class="nt">kind</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">ConfigMap</span>
</pre></div>
</div>
</div>
</section>
</section>
<section id="npu-pod">
<h2>4. NPU와 함께 Pod 배포<a class="headerlink" href="#npu-pod" title="이 제목에 대한 퍼머링크"></a></h2>
<p>NPU를 Pod에 할당하기 위해서는 <code class="docutils literal notranslate"><span class="pre">spec.containers[].resources.limits</span></code> 에 아래와 같이 추가한다.</p>
<div class="highlight-yaml notranslate"><div class="highlight"><pre><span></span><span class="nt">resources</span><span class="p">:</span>
<span class="w">  </span><span class="nt">limits</span><span class="p">:</span>
<span class="w">    </span><span class="nt">beta.furiosa.ai/npu</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;1&quot;</span><span class="w"> </span><span class="c1"># requesting 1 NPU</span>
</pre></div>
</div>
<p>Pod 생성을 위한 <a class="reference external" href="https://github.com/furiosa-ai/furiosa-sdk/blob/0.8.0/kubernetes/deployments/pod-example.yaml">전체 예제</a> 는 다음과 같다.</p>
<div class="highlight-sh notranslate"><div class="highlight"><pre><span></span>$<span class="w"> </span>cat<span class="w"> </span>&gt;<span class="w"> </span>npu-pod.yaml<span class="w"> </span><span class="s">&lt;&lt;EOL</span>
<span class="s">apiVersion: v1</span>
<span class="s">kind: Pod</span>
<span class="s">metadata:</span>
<span class="s">  name: npu-pod</span>
<span class="s">spec:</span>
<span class="s">  containers:</span>
<span class="s">    - name: npu-pod</span>
<span class="s">      image: ubuntu:focal</span>
<span class="s">      resources:</span>
<span class="s">        limits:</span>
<span class="s">          cpu: &quot;4&quot;</span>
<span class="s">          memory: &quot;8Gi&quot;</span>
<span class="s">          beta.furiosa.ai/npu: &quot;1&quot;</span>
<span class="s">        requests:</span>
<span class="s">          cpu: &quot;4&quot;</span>
<span class="s">          memory: &quot;8Gi&quot;</span>
<span class="s">          beta.furiosa.ai/npu: &quot;1&quot;</span>
<span class="s">EOL</span>

$<span class="w"> </span>kubectl<span class="w"> </span>apply<span class="w"> </span>-f<span class="w"> </span>npu-pod.yaml
</pre></div>
</div>
<p>Pod 생성 뒤에는 다음과 같이 NPU 할당을 확인해볼 수 있다.</p>
<div class="highlight-sh notranslate"><div class="highlight"><pre><span></span>$<span class="w"> </span>kubectl<span class="w"> </span>get<span class="w"> </span>pods<span class="w"> </span>npu-pod<span class="w"> </span>-o<span class="w"> </span>yaml<span class="w"> </span><span class="p">|</span><span class="w"> </span>grep<span class="w"> </span>beta.furiosa.ai/npu
<span class="w">    </span>beta.furiosa.ai/npu:<span class="w"> </span><span class="s2">&quot;1&quot;</span>
<span class="w">    </span>beta.furiosa.ai/npu:<span class="w"> </span><span class="s2">&quot;1&quot;</span>
</pre></div>
</div>
<p>다수의 NPU 장치가 있는 노드에서 Pod을 생성했을 때, 어떤 장치가 할당되었는지는 아래와 같이 확인할 수 있다.
(SDK의 어플리케이션은 자동으로 할당된 NPU 장치를 인식한다.)</p>
<div class="highlight-sh notranslate"><div class="highlight"><pre><span></span>$<span class="w"> </span>kubectl<span class="w"> </span><span class="nb">exec</span><span class="w"> </span>npu-pod<span class="w"> </span>-it<span class="w"> </span>--<span class="w"> </span>/bin/bash
root@npu-pod:/#<span class="w"> </span><span class="nb">echo</span><span class="w"> </span><span class="nv">$NPU_DEVNAME</span>
npu0pe0-1
</pre></div>
</div>
<p>Pod 안에 furiosa-toolkit을 설치하면 아래처럼 furiosactl 커맨드를 이용하여 더 자세한 장치 정보를
확인할 수 있다. APT를 이용한 설치 방법은 <a class="reference internal" href="installation.html#setupaptrepository"><span class="std std-ref">APT 서버 설정</span></a> 찾을 수 있다.</p>
<div class="highlight-sh notranslate"><div class="highlight"><pre><span></span>root@npu-pod:/#<span class="w"> </span>furiosactl
furiosactl<span class="w"> </span>controls<span class="w"> </span>the<span class="w"> </span>FURIOSA<span class="w"> </span>NPU.

Find<span class="w"> </span>more<span class="w"> </span>information<span class="w"> </span>at:<span class="w"> </span>https://furiosa.ai/

Basic<span class="w"> </span>Commands:
<span class="w">  </span>version<span class="w">    </span>Print<span class="w"> </span>the<span class="w"> </span>furiosactl<span class="w"> </span>version<span class="w"> </span>information
<span class="w">  </span>info<span class="w">       </span>Show<span class="w"> </span>information<span class="w"> </span>one<span class="w"> </span>or<span class="w"> </span>many<span class="w"> </span>NPU<span class="o">(</span>s<span class="o">)</span>
<span class="w">  </span>config<span class="w">     </span>Get/Set<span class="w"> </span>configuration<span class="w"> </span><span class="k">for</span><span class="w"> </span>NPU<span class="w"> </span>environment

Usage:
<span class="w">  </span>furiosactl<span class="w"> </span>COMMAND

root@npu-pod:/#<span class="w"> </span>furiosactl<span class="w"> </span>info
+------+------------------+-------+--------+--------------+---------+
<span class="p">|</span><span class="w"> </span>NPU<span class="w">  </span><span class="p">|</span><span class="w"> </span>Name<span class="w">             </span><span class="p">|</span><span class="w"> </span>Temp.<span class="w"> </span><span class="p">|</span><span class="w"> </span>Power<span class="w">  </span><span class="p">|</span><span class="w"> </span>PCI-BDF<span class="w">      </span><span class="p">|</span><span class="w"> </span>PCI-DEV<span class="w"> </span><span class="p">|</span>
+------+------------------+-------+--------+--------------+---------+
<span class="p">|</span><span class="w"> </span>npu0<span class="w"> </span><span class="p">|</span><span class="w"> </span>FuriosaAI<span class="w"> </span>Warboy<span class="w"> </span><span class="p">|</span><span class="w">  </span><span class="m">40</span>°C<span class="w"> </span><span class="p">|</span><span class="w"> </span><span class="m">1</span>.37<span class="w"> </span>W<span class="w"> </span><span class="p">|</span><span class="w"> </span><span class="m">0000</span>:01:00.0<span class="w"> </span><span class="p">|</span><span class="w"> </span><span class="m">509</span>:0<span class="w">   </span><span class="p">|</span>
+------+------------------+-------+--------+--------------+---------+
</pre></div>
</div>
</section>
<section id="id4">
<h2>5. NPU 모니터링<a class="headerlink" href="#id4" title="이 제목에 대한 퍼머링크"></a></h2>
<p><code class="docutils literal notranslate"><span class="pre">npu-metrics-exporter</span></code> 를 설치하면 DaemonSet과 Service가 생성된다.
DaemonSet을 통해 실행되는 Pod에서는 NPU의 각종 상태 정보를 지표로 출력하여 모니터링에 도움이 되는 정보를 제공한다.
지표 정보는 Prometheus 형식으로 표현되며, Kubernetes 클러스터내에 service discovery가 활성화 된 Prometheus가 설치되어 있다면
Prometheus가 Exporter를 통해 출력되는 데이터를 자동으로 수집한다.</p>
<p>수집된 데이터는 Grafana 등의 시각화 도구를 통해 확인할 수 있다.</p>
<table class="docutils align-default" id="id10">
<caption><span class="caption-text">npu-metrics-exporter 수집 항목 목록</span><a class="headerlink" href="#id10" title="이 표에 대한 퍼머링크"></a></caption>
<colgroup>
<col style="width: 50%" />
<col style="width: 50%" />
</colgroup>
<thead>
<tr class="row-odd"><th class="head"><p>이름</p></th>
<th class="head"><p>설명</p></th>
</tr>
</thead>
<tbody>
<tr class="row-even"><td><p>furiosa_npu_alive</p></td>
<td><p>NPU 동작 상태 (1:정상)</p></td>
</tr>
<tr class="row-odd"><td><p>furiosa_npu_uptime</p></td>
<td><p>NPU 동작 시간 (s)</p></td>
</tr>
<tr class="row-even"><td><p>furiosa_npu_error</p></td>
<td><p>NPU에서 감지된 에러의 수</p></td>
</tr>
<tr class="row-odd"><td><p>furiosa_npu_hw_temperature</p></td>
<td><p>NPU의 컴포넌트 별 온도 (°mC)</p></td>
</tr>
<tr class="row-even"><td><p>furiosa_npu_hw_power</p></td>
<td><p>NPU의 순간 전력사용량 (µW)</p></td>
</tr>
<tr class="row-odd"><td><p>furiosa_npu_hw_voltage</p></td>
<td><p>NPU의 순간 전압 (mV)</p></td>
</tr>
<tr class="row-even"><td><p>furiosa_npu_hw_current</p></td>
<td><p>NPU의 순간 전류 (mA)</p></td>
</tr>
</tbody>
</table>
</section>
</section>


           </div>
          </div>
          <footer><div class="rst-footer-buttons" role="navigation" aria-label="Footer">
        <a href="serving.html" class="btn btn-neutral float-left" title="모델 서버 (서빙 프레임워크)" accesskey="p" rel="prev"><span class="fa fa-arrow-circle-left" aria-hidden="true"></span> Previous</a>
        <a href="vm_support.html" class="btn btn-neutral float-right" title="가상 머신 환경 지원" accesskey="n" rel="next">Next <span class="fa fa-arrow-circle-right" aria-hidden="true"></span></a>
    </div>

  <hr/>

  <div role="contentinfo">
    <p>&#169; 저작권 2023, FuriosaAI, Inc..</p>
  </div>

  Built with <a href="https://www.sphinx-doc.org/">Sphinx</a> using a
    <a href="https://github.com/readthedocs/sphinx_rtd_theme">theme</a>
    provided by <a href="https://readthedocs.org">Read the Docs</a>.
   

</footer>
        </div>
      </div>
    </section>
  </div>
  <script>
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script> 

</body>
</html>